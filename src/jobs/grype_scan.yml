description: |
  This job performs vulnerability scanning using Grype.
  It automatically detects whether to scan Docker images or source code based on .grype.yaml configuration.
executor:
  name: machine
  resource_class: << parameters.resource_class >>
parameters:
  resource_class:
    type: enum
    enum: ["small", "medium", "medium+", "large", "xlarge", "2xlarge", "2xlarge+"]
    default: medium
steps:
  - checkout
  - attach_workspace:
      at: /tmp
  - run:
      name: Check for Grype config and determine scan type
      command: |
        if [ ! -f .grype.yaml ]; then
          echo "Error: .grype.yaml configuration file not found in repository at root level."
          echo "Please add a .grype.yaml file with appropriate vulnerability ignore rules."
          exit 1
        fi

        # Check if scan is disabled (handle various YAML formats)
        if grep -E '^\s*disabled:\s*(true|True|TRUE|yes|Yes|YES)\s*$' .grype.yaml; then
          echo "Grype scan is disabled in .grype.yaml"
          circleci-agent step halt
        fi

        # Determine scan type
        SCAN_TYPE=""

        # Check explicit scan-type configuration (handle spaces, quotes, etc.)
        if grep -E "^\s*scan-type:\s*[\"']?source[\"']?\s*$" .grype.yaml; then
          SCAN_TYPE="source"
          echo "scan-type: source found in .grype.yaml"
        elif grep -E "^\s*scan-type:\s*[\"']?image[\"']?\s*$" .grype.yaml; then
          SCAN_TYPE="image"
          echo "scan-type: image found in .grype.yaml"
        else
          # Auto-detect based on Dockerfile presence
          if [ -f Dockerfile ]; then
            SCAN_TYPE="image"
            echo "Dockerfile found and no scan-type specified - defaulting to image scan"
          else
            SCAN_TYPE="source"
            echo "No Dockerfile found and no scan-type specified - defaulting to source scan"
          fi
        fi

        echo "export GRYPE_SCAN_TYPE=$SCAN_TYPE" >> $BASH_ENV
        echo "Scan type determined: $SCAN_TYPE"
  - run:
      name: Check dependencies
      command: |
        if ! command -v jq &> /dev/null; then
          echo "jq could not be found, installing..."
          sudo apt-get update && sudo apt-get install -y jq
        fi
  - run:
      name: Load Docker image if image scan
      command: |
        if [ "$GRYPE_SCAN_TYPE" = "image" ]; then
          if [ -f /tmp/docker-image.tar ]; then
            docker load -i /tmp/docker-image.tar
            echo "Docker image loaded successfully"
          else
            echo "Warning: Docker image tar file not found in workspace."
            echo "This is expected for source-only repositories."
            # Check if we actually have a Dockerfile and should have built an image
            if [ -f Dockerfile ]; then
              echo "Error: Dockerfile exists but no Docker image found in workspace."
              echo "Make sure the Build job creates and persists the Docker image."
              exit 1
            fi
          fi
        fi
  - run:
      name: Install Grype
      command: |
        echo "Installing Grype vulnerability scanner..."
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin

        # Verify installation succeeded
        if ! command -v grype &> /dev/null; then
          echo "Error: Grype installation failed - command not found"
          exit 1
        fi

        # Display version for debugging
        echo "Grype installed successfully:"
        grype version
  - run:
      name: Run Grype scan
      command: |
        set -e  # Exit on error

        if [ "$GRYPE_SCAN_TYPE" = "image" ]; then
          IMAGE_NAME="${DOCKER_ORG:-mojaloop}/$CIRCLE_PROJECT_REPONAME:local"
          echo "Scanning Docker image: $IMAGE_NAME"

          # Verify image exists before scanning
          if ! docker images | grep -q "$CIRCLE_PROJECT_REPONAME.*local"; then
            echo "Error: Docker image $IMAGE_NAME not found"
            echo "Available images:"
            docker images
            exit 1
          fi

          # Run scan with error handling (table)
          if ! grype $IMAGE_NAME -c .grype.yaml -o table > grype-results.txt 2>&1; then
            echo "Error: Grype image scan failed"
            cat grype-results.txt
            exit 1
          fi

          # Generate JSON output (stderr to separate file to avoid JSON corruption)
          if ! grype $IMAGE_NAME -c .grype.yaml -o json > grype-results.json 2>grype-json-errors.log; then
            echo "Error: Failed to generate JSON output"
            cat grype-json-errors.log
            exit 1
          fi
        else
          echo "Scanning source code in current directory (SBOM-first)"

          # Ensure syft is present (install if missing)
          if ! command -v syft &> /dev/null; then
            echo "syft not found â€” installing..."
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          fi

          # Generate SBOM
          echo "Generating SBOM with syft..."
          syft dir:. -o json > sbom.json
          echo "sbom.json created: $(stat -c%s sbom.json || true) bytes"

          # Detect and remove any artifacts with empty/non-pkg purls (defensive)
          jq -c '.artifacts[] | select((.purl // "") == "" or ((.purl // "") | test("^pkg:") | not))' sbom.json > bad-purls.json || true
          if [ -s bad-purls.json ]; then
            echo "Warning: sbom.json contains artifacts with empty/invalid purl; creating sbom.fixed.json with those removed"
            jq 'del(.artifacts[] | select((.purl // "") == "" or ((.purl // "") | test("^pkg:") | not)))' sbom.json > sbom.fixed.json
          else
            cp sbom.json sbom.fixed.json
          fi

          # Validate cleaned SBOM JSON
          if ! jq empty sbom.fixed.json 2>/dev/null; then
            echo "Error: sbom.fixed.json is invalid JSON"
            head -n 40 sbom.fixed.json || true
            exit 1
          fi

          # Run a human-readable table output first (to keep original behavior)
          if ! grype sbom:sbom.fixed.json -c .grype.yaml -o table > grype-results.txt 2>&1; then
            echo "Warning: Grype sbom table output failed; will still attempt JSON run (see grype-results.txt)"
            cat grype-results.txt || true
          fi

          # Primary: run grype against the cleaned SBOM and capture stderr separately
          echo "Running grype (JSON) against sbom.fixed.json..."
          if grype sbom:sbom.fixed.json -c .grype.yaml -o json > grype-results.json 2>grype-json-errors.log; then
            echo "grype sbom scan (json) completed"
          else
            echo "Warning: grype sbom JSON run failed; printing stderr and attempting fallback to 'grype dir:.'"
            echo "=== grype-json-errors.log (first 200 lines) ==="
            sed -n '1,200p' grype-json-errors.log || true

            # Fallback: attempt original directory scan but still capture stderr separately (prevents stdout corruption)
            echo "Attempting fallback: grype dir:. -o json"
            if ! grype dir:. -c .grype.yaml -o json > grype-results.json 2>grype-json-errors.log; then
              echo "Error: Fallback grype dir: JSON run failed; see grype-json-errors.log"
              sed -n '1,200p' grype-json-errors.log || true
              exit 1
            fi
          fi
        fi

        # Verify scan produced valid results
        if [ ! -s grype-results.json ]; then
          echo "Error: Grype scan produced empty results"
          exit 1
        fi

        # Validate JSON format
        if ! jq empty grype-results.json 2>/dev/null; then
          echo "Error: Grype scan produced invalid JSON"
          head -20 grype-results.json || true
          echo "=== grype-json-errors.log (first 200 lines) ==="
          sed -n '1,200p' grype-json-errors.log || true
          exit 1
        fi

        # Display any warnings from the scan
        if [ -f grype-json-errors.log ] && [ -s grype-json-errors.log ]; then
          echo "=== Grype Scan Warnings ==="
          cat grype-json-errors.log
        fi

        echo "=== Grype Scan Results ==="
        cat grype-results.txt || true
        echo ""
        echo "Scan completed successfully"
  - run:
      name: Check for critical, high and medium vulnerabilities
      command: |
        # Validate JSON before processing
        if ! jq empty grype-results.json 2>/dev/null; then
          echo "Error: Invalid JSON in grype-results.json"
          exit 1
        fi

        # Count vulnerabilities in the filtered results (handle missing matches array)
        CRITICAL_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Critical")] | length' grype-results.json || echo "0")
        HIGH_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "High")] | length' grype-results.json || echo "0")
        MEDIUM_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Medium")] | length' grype-results.json || echo "0")

        echo "Critical vulnerabilities found: $CRITICAL_COUNT"
        echo "High vulnerabilities found: $HIGH_COUNT"
        echo "Medium vulnerabilities found: $MEDIUM_COUNT"

        # List remaining critical, high and medium vulnerabilities for awareness
        if [ "$CRITICAL_COUNT" -gt 0 ]; then
          echo ""
          echo "Critical severity vulnerabilities:"
          jq -r '.matches[]? | select(.vulnerability.severity == "Critical") | "- \(.artifact.name // "unknown") \(.artifact.version // "unknown"): \(.vulnerability.id)"' grype-results.json
        fi

        if [ "$HIGH_COUNT" -gt 0 ]; then
          echo ""
          echo "High severity vulnerabilities:"
          jq -r '.matches[]? | select(.vulnerability.severity == "High") | "- \(.artifact.name // "unknown") \(.artifact.version // "unknown"): \(.vulnerability.id)"' grype-results.json
        fi

        if [ "$MEDIUM_COUNT" -gt 0 ]; then
          echo ""
          echo "Medium severity vulnerabilities:"
          jq -r '.matches[]? | select(.vulnerability.severity == "Medium") | "- \(.artifact.name // "unknown") \(.artifact.version // "unknown"): \(.vulnerability.id)"' grype-results.json
        fi

        # Fail if any critical, high, or medium vulnerabilities are found
        if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ] || [ "$MEDIUM_COUNT" -gt 0 ]; then
          echo ""
          echo "Critical, High, or Medium vulnerabilities found. Failing the build."
          exit 1
        fi
  - store_artifacts:
      path: grype-results.json
      destination: grype-scan/scan-results.json
  - store_artifacts:
      path: grype-results.txt
      destination: grype-scan/scan-results.txt
